---
author: 
  name: 木子识时务
  link: https://github.com/sbwcwso
editLink: true
title: P2P应用
date: 2021-08-16 10:50:38
permalink: /pages/f013b7/
categories: 
  - 计算机网络
tags: 
  - 
---

# P2P应用

```markmap
- [P2P应用](#p2p应用)
  - [纯 P2P 架构](#纯-p2p-架构)
  - [文件分发: 客户机/服务器 vs P2p](#文件分发-客户机服务器-vs-p2p)
    - [文件分发: 客户机/服务器(C/S)](#文件分发-客户机服务器cs)
    - [文件分发: P2P](#文件分发-p2p)
    - [C/S vs P2P](#cs-vs-p2p)
  - [BitTorrent](#bittorrent)
  - [索引技术](#索引技术)
    - [集中式索引](#集中式索引)
    - [洪泛式查询: Query flooding](#洪泛式查询-query-flooding)
    - [层次式覆盖网络](#层次式覆盖网络)
  - [P2P案例应用: Skype](#p2p案例应用-skype)
```

## 纯 P2P 架构

::: note 特点
* Peer-to-peer
* 没有服务器
* 任意端系统之间直接通信
* 节点阶段性接入Internet
* 节点可能更换IP地址
:::


## 文件分发: 客户机/服务器 vs P2p

* 问题 : 从一个服务器向 $N$ 个节点分发一个文件需要多长时间

![20210825084707-2021-08-25-08-47-07](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825084707-2021-08-25-08-47-07.png)

### 文件分发: 客户机/服务器(C/S)

* 服务器串行地发送 $N$ 个副本的时间
  * 时间：$NF/u_s$
* 客户机 $i$ 需要 $F/d_i$ 时间下载

### 文件分发: P2P

### C/S vs P2P

![20210825085242-2021-08-25-08-52-42](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825085242-2021-08-25-08-52-42.png)

## BitTorrent

![20210825085445-2021-08-25-08-54-45](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825085445-2021-08-25-08-54-45.png)

* tracker: 跟踪参与torrent的节点
* torrent: 交换同一个文件的文件块的节点组

:::note 基本特点
* 文件划分为256KB的chunk
* 节点加入torrent
  * 没有chunk，但是会逐渐积累
  * 向tracker注册以获得节点清单，与某些节点（“邻居”）建立连接
* 下载的同时，节点需要向其他节点上传 chunk
* 节点可能加入或离开
* 一旦节点获得完整的文件，它可能（自私地）离开或（无私地）留下
:::

:::note 获取chunk
* 给定任一时刻，不同的节点持有文件的不同chunk集合
* 节点(Alice)定期查询每个邻居所持有的chunk列表
* 节点发送请求，请求获取缺失的chunk
  * 稀缺优先
:::

::: note 发送chunk: tit-for-tat
* Alice向4个邻居发送chunk：正在向其发送Chunk，速率最快的4个
  * 每10秒重新评估top 4
* 每30秒随机选择一个其他节点，向其发送chunk
* 新选择节点可能加入top 4
  * "optimistically unchoke"
:::

:::tip BT 技术对网络性能的危害
:::

## 索引技术

::: tip P2P系统的索引
信息到节点位置(IP地址+端口号)的映射
:::

::: note 文件共享(电驴)
* 利用索引动态跟踪节点所共享的文件的位置
* 节点需要告诉索引它拥有哪些文件
* 节点搜索索引，从而获知能够得到哪些文件
:::

:::note 即时消息(QQ)
* 索引负责将用户名映射到位置
* 当用户开启IM应用时，需要通知索引它的位置
* 节点检索索引，确定用户的IP地址
:::

### 集中式索引

:::note Napster最早采用集中式索引

![20210825090946-2021-08-25-09-09-47](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825090946-2021-08-25-09-09-47.png)

* 节点加入时，通知中央服务器
  * IP 地址
  * 内容
* Alice 查找 "Hey Jude"
* Alice 从 Bob 处请求文件
:::

:::tip 内容和文件传输是分布式的，但是内容定位是高度集中式的
:::

:::warning 存在的问题
* 单点失效问题
* 性能瓶颈
* 版权问题
:::

### 洪泛式查询: Query flooding

:::note 特点
* 完全分布式架构
* Gnutella采用这种架构
* 每个节点对它共享的文件进行索引，且只对它共享的文件进行索引
:::

:::note 特点
* 覆盖网络(overlay network): Graph
  * 节点X与Y之间如果有TCP连接，那么构成一个边
  * 所有的活动节点和边构成覆盖网络
  * 边：虚拟链路
  * 节点一般邻居数少于10个
:::

:::note 工作过程

![20210825091616-2021-08-25-09-16-16](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825091616-2021-08-25-09-16-16.png)

* 查询消息通过已有的TCP连接发送
* 节点转发查询消息
* 如果查询命中，则利用反向路径发回查询节点
:::

::: warning 缺点
* 会加重网络的负担
:::

### 层次式覆盖网络

::: note 特点
![20210825091837-2021-08-25-09-18-37](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825091837-2021-08-25-09-18-37.png)

* 介于集中式索引和洪泛查询之间的方法
* 每个节点或者是一个超级节点，或者被分配一个超级节点
  * 节点和超级节点间维持TCP连接
  * 某些超级节点对之间维持TCP连接
* 超级节点负责跟踪子节点的内容
:::

## P2P案例应用: Skype

:::note 特点

![20210825092221-2021-08-25-09-22-21](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825092221-2021-08-25-09-22-21.png)

* 本质上是P2P的：用户/节点对之间直接通信
* 私有应用层协议
* 采用层次式覆盖网络架构
* 索引负责维护用户名与IP地址间的映射
* 索引分布在超级节点上
:::
