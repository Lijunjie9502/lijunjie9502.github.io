---
author: 
  name: 木子识时务
  link: https://github.com/sbwcwso
editLink: true
title: Socket编程
date: 2021-08-25 09:26:39
permalink: /pages/ce908b/
categories: 
  - 计算机网络
tags: 
  - 
---

# Socket 编程

```markmap
- [Socket 编程](#socket-编程)
  - [应用编程接口(API)](#应用编程接口api)
    - [网络程设计接口](#网络程设计接口)
    - [应用编程接口 API](#应用编程接口-api)
    - [几种典型的应用编程接口](#几种典型的应用编程接口)
  - [Socket API 概述](#socket-api-概述)
    - [Socket 抽象](#socket-抽象)
    - [地址结构](#地址结构)
    - [Socket API 函数(WinSock)](#socket-api-函数winsock)
      - [`WSAStartup`](#wsastartup)
      - [`WSACleanup`](#wsacleanup)
      - [`socket`](#socket)
      - [`closesocket`](#closesocket)
      - [`bind`](#bind)
```

## 应用编程接口(API)

### 网络程设计接口

![20210825093613-2021-08-25-09-36-14](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825093613-2021-08-25-09-36-14.png)
* Socket 编程针对传输层

### 应用编程接口 API

:::note 应用编程接口 API (Application Programming Interface)
![20210825094258-2021-08-25-09-42-58](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825094258-2021-08-25-09-42-58.png)

* **应用进程的控制权**和**操作系统的控制权**进行转换的一个系统调用接口
:::

### 几种典型的应用编程接口

:::note 典型的应用编程接口
* Berkeley UNIX 操作系统定义了一种 API，称为套接字接口(socket interface)，简称**套接字** (socket)
  * 应用最广
* 微软公司在其操作系统中采用了套接字接口 API，形成了一个稍有不同的 API，并称之为 Windows Socket Interface，**WINSOCK**
* AT&T 为其 UNIX 系统 V 定义了一种 API，简写为 TLI (Transport Layer Interface)
:::

## Socket API 概述

:::note 最初设计
* 面向BSD UNIX-Berkley
* 面向TCP/IP协议栈接口
:::

:::note 目前情况
* 事实上的工业标准
* 绝大多数操作系统都支持
:::

:::note Internet网络应用最典型的API接口
:::
:::note 通信模型
* 客户/服务器（C/S）
:::

:::note 应用进程间通信的抽象机制
:::details 示意图
![20210825095224-2021-08-25-09-52-24](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825095224-2021-08-25-09-52-24.png)
:::

:::note 标识通信端点（对外）
* IP地址+端口号
:::details 示意图
![20210825095320-2021-08-25-09-53-20](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825095320-2021-08-25-09-53-20.png)
:::

:::tip 操作系统/进程如何管理套接字（对内）？
* 套接字描述符（socket descriptor）
  * 小整数
:::

:::warning 套接字对内，对外管理机制是不同的
:::

### Socket 抽象

* 类似于文件的抽象
* 当应用进程创建套接字时，操作系统分配一个数据结构存储该套接字相关信息
* 返回套接字描述符
![20210825100049-2021-08-25-10-00-49](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825100049-2021-08-25-10-00-49.png)

### 地址结构

:::note 已定义结构 sockaddr_in 来表示地址结构

```c
struct sockaddr_in
{
u_char sin_len;           /* 地址长度 */
u_char sin_family;        /* 地址族(TCP/IP：AF_INET) */
u_short sin_port;         /* 端口号 */
struct in_addr sin_addr;  /* IP地址 */
char sin_zero[8];         /* 未用(置0) */
}
```

::: tip
使用TCP/IP协议簇的网络应用程序声明端点地址变量时，使用结构 `sockaddr_in`
:::

### Socket API 函数(WinSock)

![20210825100822-2021-08-25-10-08-22](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825100822-2021-08-25-10-08-22.png)

#### `WSAStartup`

#### `WSACleanup`

`int WSACleanup (void)`

* 应用程序在完成对请求的Socket库的使用，最后要调用WSACleanup函数
* 解除与Socket库的绑定
* 释放Socket库所占用的系统资源

#### `socket`

* 创建套接字
* 操作系统返回套接字描述符（sd）
* 第一个参数(协议族)
  * protofamily = PF_INET（TCP/IP）
* 第二个参数(套接字类型):
  * type = SOCK_STREAM,SOCK_DGRAM or SOCK_RAW（TCP/IP）
* 第三个参数(协议号):0为默认

* 例：创建一个流套接字的代码段

``` c
struct protoent *p;
p=getprotobyname("tcp");
SOCKET sd=socket(PF_INET,SOCK_STREAM,p->p_proto);
```

::: tip Socket面向TCP/IP的服务类型
![20210825101455-2021-08-25-10-14-55](https://cdn.jsdelivr.net/gh/sbwcwso/PicBed@master/20210825101455-2021-08-25-10-14-55.png)
* `TCP`
  * 可靠、面向连接、字节流传输、点对点、全双工
* `UDP`
  * 不可靠、无连接、数据报传输
* 原始套接字
:::

#### `closesocket`

`int closesocket(SOCKET sd)`

* 关闭一个描述符为 `sd` 的套接字
* 如果多个进程共享一个套接字，调用 `closesocket`
  * 将套接字引用计数减1，减至0才关闭
* 一个进程中的多线程对一个套接字的使用无计数
  * 如果进程中的一个线程调用 `closesocket` 将一个套接字关闭，该进程中的其他线程也将不能访问该套接字
* 返回值：
  * 0：成功
  * SOCKET_ERROR：失败

#### `bind`

`int bind(sd,localaddr,addrlen)`

* 绑定套接字的本地端点地址
  * IP地址+端口号
* 参数:
  * 套接字描述符（`sd`）
  * 端点地址（`localaddr`）
    * 结构 `sockaddr_in`
* 客户程序一般不必调用 `bind` 函数
* 服务器端需要调用
  * 熟知端口号
    * 标准应用
  * IP地址 ❓


